# Plugin Build Makefile
# This makefile builds all StormDB workload plugins

.PHONY: all clean imdb vector ecommerce_basic ecommerce test build-dir deps-check install

# Default plugin output directory (can be overridden)
PLUGIN_DIR ?= ../build/plugins

# Go build flags for plugins (default to current platform)
GOOS ?= $(shell go env GOOS)
GOARCH ?= $(shell go env GOARCH)
GO_PLUGIN_FLAGS := -buildmode=plugin -ldflags="-s -w"
BUILD_ENV := CGO_ENABLED=1 GOOS=$(GOOS) GOARCH=$(GOARCH)

# Build all plugins
all: build-dir imdb vector ecommerce_basic ecommerce

# Create build directory
build-dir:
	@mkdir -p $(PLUGIN_DIR)

# Build IMDB plugin
imdb: build-dir
	@echo "üîå Building IMDB plugin..."
	@cd imdb_plugin && $(BUILD_ENV) go build $(GO_PLUGIN_FLAGS) -o $(PLUGIN_DIR)/imdb_plugin.so *.go
	@echo "‚úÖ IMDB plugin built: $(PLUGIN_DIR)/imdb_plugin.so"

# Build Vector plugin  
vector: build-dir
	@echo "üîå Building Vector plugin..."
	@cd vector_plugin && $(BUILD_ENV) go build $(GO_PLUGIN_FLAGS) -o $(PLUGIN_DIR)/vector_plugin.so *.go
	@echo "‚úÖ Vector plugin built: $(PLUGIN_DIR)/vector_plugin.so"

# Build E-commerce Basic plugin
ecommerce_basic: build-dir
	@echo "üîå Building E-commerce Basic plugin..."
	@cd ecommerce_basic_plugin && $(BUILD_ENV) go build $(GO_PLUGIN_FLAGS) -o $(PLUGIN_DIR)/ecommerce_basic_plugin.so *.go
	@echo "‚úÖ E-commerce Basic plugin built: $(PLUGIN_DIR)/ecommerce_basic_plugin.so"

# Build E-commerce plugin
ecommerce: build-dir
	@echo "üîå Building E-commerce plugin..."
	@cd ecommerce_plugin && $(BUILD_ENV) go build $(GO_PLUGIN_FLAGS) -o $(PLUGIN_DIR)/ecommerce_plugin.so *.go
	@echo "‚úÖ E-commerce plugin built: $(PLUGIN_DIR)/ecommerce_plugin.so"

# Test all plugins
test:
	@echo "üß™ Testing plugins..."
	@cd imdb_plugin && go test -v ./...
	@cd vector_plugin && go test -v ./...
	@cd ecommerce_basic_plugin && go test -v ./...
	@cd ecommerce_plugin && go test -v ./...
	@echo "‚úÖ Plugin tests completed"

# Check plugin dependencies
deps-check:
	@echo "üì¶ Checking plugin dependencies..."
	@cd imdb_plugin && go mod verify && go mod tidy
	@cd vector_plugin && go mod verify && go mod tidy
	@cd ecommerce_basic_plugin && go mod verify && go mod tidy
	@cd ecommerce_plugin && go mod verify && go mod tidy
	@echo "‚úÖ Plugin dependencies verified"

# Clean built plugins
clean:
	@echo "üßπ Cleaning plugins..."
	@rm -f $(PLUGIN_DIR)/*.so
	@echo "‚úÖ Plugin cleanup complete"

# Install plugins to system directory (requires sudo)
install: all
	@echo "üì¶ Installing plugins to /usr/local/lib/stormdb/plugins..."
	@sudo mkdir -p /usr/local/lib/stormdb/plugins
	@sudo cp $(PLUGIN_DIR)/*.so /usr/local/lib/stormdb/plugins/
	@echo "‚úÖ Plugins installed to system directory"

# Development helpers
fmt:
	@echo "üé® Formatting plugin code..."
	@cd imdb_plugin && go fmt ./...
	@cd vector_plugin && go fmt ./...
	@cd ecommerce_basic_plugin && go fmt ./...
	@cd ecommerce_plugin && go fmt ./...
	@echo "‚úÖ Plugin code formatted"

vet:
	@echo "üîç Running go vet on plugins..."
	@cd imdb_plugin && go vet ./...
	@cd vector_plugin && go vet ./...
	@cd ecommerce_basic_plugin && go vet ./...
	@cd ecommerce_plugin && go vet ./...
	@echo "‚úÖ Plugin static analysis complete"
